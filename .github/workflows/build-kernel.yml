name: Build KernelSU Pixel 3/3XL Kernel

on:
  workflow_dispatch:  # 手动触发编译
  push:
    branches:
      - main
    paths:
      - 'kernel/**'
      - 'arch/**'
      - 'Makefile'
      - '.github/workflows/build-kernel.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false  # 禁用子模块检出
          fetch-depth: 0     # 获取完整历史记录

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential cpio curl flex git \
            libncurses5-dev libssl-dev libelf-dev lz4 \
            python3 unzip wget xz-utils zip zstd \
            device-tree-compiler

      - name: Set environment variables
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "KERNEL_RELEASE=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Install ARM64 cross-compiler
        run: |
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build for Pixel 3XL (bluecross)
        run: |
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # 使用你仓库内的构建配置
          BUILD_CONFIG=build.config.bluecross_no-cfi ./build/build.sh
          
        continue-on-error: false

      - name: Collect build artifacts
        if: success()
        run: |
          mkdir -p output
          
          # 复制内核镜像
          if [ -f dist/Image ]; then
            cp dist/Image output/Image
            gzip -c dist/Image > output/Image.gz
          fi
          
          # 复制内核模块
          if [ -d dist/lib/modules ]; then
            cp -r dist/lib/modules output/
          fi
          
          # 生成构建信息
          cat > output/build_info.txt << EOF
          Build Date: ${{ env.BUILD_DATE }}
          Build Time: ${{ env.KERNEL_RELEASE }}
          Repository: ${{ github.repository }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          EOF
          
          ls -lh output/

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: pixel-3xl-kernel-${{ env.KERNEL_RELEASE }}
          path: output/
          retention-days: 90

      - name: Create Release (optional)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: output/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Kernel build failed!"
          echo "Check the logs above for details."
